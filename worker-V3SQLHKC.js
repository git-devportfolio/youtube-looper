importScripts("/lame.all.js");function A(n){let r=new Int16Array(n.length);for(let t=0;t<n.length;t++){let s=Math.max(-1,Math.min(1,n[t]));r[t]=s<0?s*32768:s*32767}return r}function B(n){try{let{channelData:r,sampleRate:t,numberOfChannels:s,length:g}=n,y=192,u=new lamejs.Mp3Encoder(s,t,y),a=[],m=1152,l=g,i=0,p=r.map(e=>A(e));for(let e=0;e<l;e+=m){let o=Math.min(e+m,l),M=o-e;if(s===1){let f=p[0].subarray(e,o),c=u.encodeBuffer(f);c.length>0&&a.push(c)}else{let f=p[0].subarray(e,o),c=p[1].subarray(e,o),d=u.encodeBuffer(f,c);d.length>0&&a.push(d)}i+=M;let b=Math.round(i/l*100);postMessage({type:"progress",progress:b})}let h=u.flush();h.length>0&&a.push(h),postMessage({type:"complete",mp3Data:a})}catch(r){let t=r instanceof Error?r.message:"Unknown error during MP3 encoding";postMessage({type:"error",error:t})}}addEventListener("message",({data:n})=>{n.type==="encode"&&B(n.audioBuffer)});
