<!-- Modal Popup avec onglets -->
@if (isOpen()) {
  <div class="modal-overlay" (click)="close()">
    <div class="modal" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="modal-header">
        <h2 class="modal-title">Contrôles Audio</h2>
        <button class="modal-close" (click)="close()" aria-label="Fermer">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <!-- Onglets -->
      <div class="tabs">
        <button
          class="tab"
          [class.tab--active]="activeTab() === 'pitch'"
          (click)="setActiveTab('pitch')"
          type="button">
          Tonalité
        </button>
        <button
          class="tab"
          [class.tab--active]="activeTab() === 'speed'"
          (click)="setActiveTab('speed')"
          type="button">
          Vitesse
        </button>
      </div>

      <!-- Contenu principal -->
      <div class="modal-content">
        <!-- Onglet Pitch -->
        @if (activeTab() === 'pitch') {
          <div class="tab-content">
            <!-- Description -->
            <p class="description">
              Ajustez la tonalité de -6 à +6 demi-tons sans modifier la vitesse
            </p>

            <!-- Stepper -->
            <div class="stepper">
              <button
                class="stepper-btn"
                (click)="decreaseTempPitch()"
                [disabled]="!canDecreasePitch()"
                aria-label="Diminuer d'un demi-ton">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>

              <div class="stepper-display">
                <div class="stepper-value">{{ tempPitchLabel() }}</div>
                <div class="stepper-subtitle">
                  @if (_tempPitch() === 0) {
                    <span>Tonalité originale</span>
                  } @else if (_tempPitch() > 0) {
                    <span>Plus aigu</span>
                  } @else {
                    <span>Plus grave</span>
                  }
                </div>
              </div>

              <button
                class="stepper-btn"
                (click)="increaseTempPitch()"
                [disabled]="!canIncreasePitch()"
                aria-label="Augmenter d'un demi-ton">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>

            <!-- Reset pitch -->
            <button
              class="reset-btn"
              (click)="resetTempPitch()"
              [disabled]="_tempPitch() === 0">
              Réinitialiser
            </button>
          </div>
        }

        <!-- Onglet Speed -->
        @if (activeTab() === 'speed') {
          <div class="tab-content">
            <!-- Description -->
            <p class="description">
              Ajustez la vitesse de lecture sans modifier la tonalité
            </p>

            <!-- Stepper -->
            <div class="stepper">
              <button
                class="stepper-btn"
                (click)="decreaseTempSpeed()"
                [disabled]="!canDecreaseSpeed()"
                aria-label="Diminuer la vitesse">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>

              <div class="stepper-display">
                <div class="stepper-value">{{ tempSpeedLabel() }}</div>
                <div class="stepper-subtitle">
                  @if (_tempSpeed() === 1.0) {
                    <span>Vitesse normale</span>
                  } @else if (_tempSpeed() < 0.7) {
                    <span>Très lent</span>
                  } @else if (_tempSpeed() < 1.0) {
                    <span>Lent</span>
                  } @else if (_tempSpeed() > 1.0) {
                    <span>Rapide</span>
                  }
                </div>
              </div>

              <button
                class="stepper-btn"
                (click)="increaseTempSpeed()"
                [disabled]="!canIncreaseSpeed()"
                aria-label="Augmenter la vitesse">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>

            <!-- Reset speed -->
            <button
              class="reset-btn"
              (click)="resetTempSpeed()"
              [disabled]="_tempSpeed() === 1.0">
              Réinitialiser
            </button>
          </div>
        }

        <!-- Erreur -->
        @if (hasError()) {
          <div class="error">
            <span class="error-icon">⚠️</span>
            <span class="error-message">{{ errorMessage() }}</span>
          </div>
        }
      </div>

      <!-- Footer avec actions -->
      <div class="modal-footer">
        <button
          class="btn btn--secondary"
          (click)="close()">
          Annuler
        </button>
        <button
          class="btn btn--primary"
          (click)="apply()"
          [disabled]="!hasChanges()">
          @if (hasChanges()) {
            <span>Appliquer</span>
          } @else {
            <span>Aucun changement</span>
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Overlay de processing (bloque toute l'UI) -->
@if (isProcessing()) {
  <div class="processing-overlay">
    <div class="processing-modal">
      <div class="processing-spinner"></div>
      <h3 class="processing-title">{{ processingStatus() }}</h3>
      <div class="processing-progress-bar">
        <div class="processing-progress-fill" [style.width.%]="processingProgress()"></div>
      </div>
      <p class="processing-percentage">{{ processingProgress() }}%</p>
      <p class="processing-info">Veuillez patienter, traitement audio en cours...</p>
    </div>
  </div>
}
