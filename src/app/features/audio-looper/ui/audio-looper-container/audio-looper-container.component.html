<div class="audio-looper-container" [attr.data-state]="loadingState()">

  <!-- État VIDE : Upload centré -->
  @if (isEmpty()) {
    <div class="centered-upload" [@fadeIn]>
      <app-file-upload (fileSelected)="onFileSelected($event)"></app-file-upload>
    </div>
  }

  <!-- État CHARGEMENT : Indicateur de chargement -->
  @if (isLoading()) {
    <div class="loading-state" [@fadeIn]>
      <div class="loading-spinner"></div>
      <p class="loading-text">Chargement de {{ currentFileName() }}...</p>
    </div>
  }

  <!-- État CHARGÉ : Interface complète avec révélation progressive -->
  @if (isLoaded()) {
    <div class="loaded-layout" [@revealLayout]>

      <!-- Upload minimisé en haut -->
      <div class="minimized-upload">
        <div class="minimized-upload__info">
          <svg class="minimized-upload__icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span class="minimized-upload__filename" [title]="currentFileName()">{{ currentFileName() }}</span>
        </div>
        <div class="minimized-upload__favorite-actions">
          <!-- Bouton étoile pour ajouter/retirer des favoris -->
          <button
            class="minimized-upload__favorite-btn"
            [class.active]="isCurrentFileFavorite()"
            [disabled]="isSavingFavorite()"
            (click)="toggleFavorite()"
            type="button"
            [title]="isCurrentFileFavorite() ? 'Retirer des favoris' : 'Ajouter aux favoris'"
          >
            <!-- Étoile vide (outline) -->
            @if (!isCurrentFileFavorite()) {
              <svg class="favorite-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            }
            <!-- Étoile pleine (filled) -->
            @if (isCurrentFileFavorite()) {
              <svg class="favorite-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
              </svg>
              <span class="favorite-badge">Favori</span>
            }
          </button>
          <!-- Bouton pour sauvegarder les modifications -->
          @if (hasUnsavedChanges()) {
            <button
              class="minimized-upload__save-btn"
              (click)="updateCurrentFavorite()"
              type="button"
              title="Sauvegarder les modifications du favori"
            >
              <svg class="save-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="17 21 17 13 7 13 7 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="7 3 7 8 15 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span class="save-text">Sauvegarder</span>
            </button>
          }
        </div>
        <div class="minimized-upload__actions">
          <button
            class="minimized-upload__button"
            (click)="changeFile()"
            type="button"
          >
            Change File
          </button>
        </div>
      </div>

      <!-- Waveform centrale -->
      <div class="waveform-section">
        <app-waveform-display [audioBuffer]="audioBuffer()"></app-waveform-display>
      </div>

      <!-- Zone des contrôles -->
      <div class="controls-section">
        <!-- Lecteur audio avec Play/Pause, temps et bouton settings -->
        <app-audio-player></app-audio-player>

        <!-- Contrôles de boucle A/B -->
        <app-loop-controls></app-loop-controls>

        <!-- Contrôle de volume avec slider et mute/unmute -->
        <!-- <app-volume-control></app-volume-control> -->
      </div>
    </div>
  }

  <!-- État ERREUR : Message d'erreur avec possibilité de réessayer -->
  @if (hasError()) {
    <div class="error-state" [@fadeIn]>
      <div class="error-state__icon">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
          <line x1="12" y1="8" x2="12" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <line x1="12" y1="16" x2="12.01" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <h3 class="error-state__title">Erreur de chargement</h3>
      <p class="error-state__message">{{ errorMessage() }}</p>
      <button
        class="error-state__button"
        (click)="changeFile()"
        type="button"
      >
        Réessayer
      </button>
    </div>
  }

</div>

<!-- Sidebar des favoris -->
<app-favorites-sidebar
  [isOpen]="sidebarOpen()"
  [favoritesCount]="favorites().length"
  [totalSize]="storageStats().totalSize"
  (close)="closeSidebar()"
  (uploadNewFile)="onUploadNewFileFromSidebar()"
  (editOrder)="onEditOrder()"
  (loadFavorite)="onLoadFavorite($event)"
  (playFavorite)="onPlayFavorite($event)">
</app-favorites-sidebar>

<!-- Modal de quota de favoris -->
<app-favorite-quota-modal
  [isOpen]="quotaModalOpen()"
  (close)="closeQuotaModal()"
  (favoriteDeleted)="onFavoriteDeleted()">
</app-favorite-quota-modal>
