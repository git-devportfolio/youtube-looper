<!-- Bouton discret pour ouvrir la popup -->
<button
  class="pitch-trigger-btn"
  (click)="open()"
  [disabled]="!isAudioReady()"
  [attr.aria-label]="'Modifier la tonalit√©: ' + pitchLabel()">
  <svg class="pitch-trigger-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 2v20M8 6l4-4 4 4M8 18l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  <span class="pitch-trigger-label">Tonalit√©</span>
  <span class="pitch-trigger-value">{{ pitchLabel() }}</span>
</button>

<!-- Modal Popup -->
@if (isOpen()) {
  <div class="pitch-modal-overlay" (click)="close()">
    <div class="pitch-modal" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="pitch-header">
        <h2 class="pitch-title">
          <span class="pitch-icon">üéº</span>
          Modifier la tonalit√©
        </h2>
        <button class="pitch-close" (click)="close()" aria-label="Fermer">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <!-- Contenu principal -->
      <div class="pitch-content">
        <!-- Description -->
        <p class="pitch-description">
          Ajustez la tonalit√© de -6 √† +6 demi-tons sans modifier la vitesse de lecture.
          Id√©al pour transposer une chanson dans votre tessiture.
        </p>

        <!-- Stepper -->
        <div class="pitch-stepper">
          <!-- Bouton - -->
          <button
            class="pitch-stepper-btn pitch-stepper-btn--decrease"
            (click)="decreasePitch()"
            [disabled]="!canDecrease() || isProcessing()"
            aria-label="Diminuer d'un demi-ton">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>

          <!-- Affichage de la valeur -->
          <div class="pitch-stepper-display">
            <div class="pitch-stepper-value">{{ pitchLabel() }}</div>
            <div class="pitch-stepper-subtitle">
              @if (currentPitch() === 0) {
                <span>Tonalit√© originale</span>
              } @else if (currentPitch() > 0) {
                <span>Plus aigu</span>
              } @else {
                <span>Plus grave</span>
              }
            </div>
          </div>

          <!-- Bouton + -->
          <button
            class="pitch-stepper-btn pitch-stepper-btn--increase"
            (click)="increasePitch()"
            [disabled]="!canIncrease() || isProcessing()"
            aria-label="Augmenter d'un demi-ton">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>

        <!-- Barre de progression visuelle -->
        <div class="pitch-progress-track">
          <div class="pitch-progress-markers">
            @for (marker of [-6, -3, 0, 3, 6]; track marker) {
              <div
                class="pitch-progress-marker"
                [class.active]="currentPitch() === marker"
                [class.zero]="marker === 0">
                <span class="pitch-progress-marker-label">{{ marker > 0 ? '+' + marker : marker }}</span>
              </div>
            }
          </div>
          <div class="pitch-progress-indicator" [style.left.%]="((currentPitch() + 6) / 12) * 100"></div>
        </div>

        <!-- Conseils -->
        <div class="pitch-tips">
          <h4 class="pitch-tips-title">üí° Conseils d'utilisation :</h4>
          <ul class="pitch-tips-list">
            <li>Transposez une chanson trop aigu√´ en descendant de 2-3 demi-tons</li>
            <li>Le timbre vocal et instrumental est pr√©serv√© gr√¢ce √† Rubberband</li>
            <li>Combinez avec le ralentissement pour un apprentissage optimal</li>
          </ul>
        </div>

        <!-- Erreur -->
        @if (hasError()) {
          <div class="pitch-error">
            <span class="pitch-error-icon">‚ö†Ô∏è</span>
            <span class="pitch-error-message">{{ errorMessage() }}</span>
          </div>
        }
      </div>

      <!-- Footer avec actions -->
      <div class="pitch-footer">
        <button
          class="pitch-btn pitch-btn--secondary"
          (click)="resetPitch()"
          [disabled]="currentPitch() === 0 || isProcessing()">
          R√©initialiser
        </button>
        <button
          class="pitch-btn pitch-btn--primary"
          (click)="close()">
          Fermer
        </button>
      </div>
    </div>
  </div>
}

<!-- Overlay de processing (bloque toute l'UI) -->
@if (isProcessing()) {
  <div class="processing-overlay">
    <div class="processing-modal">
      <div class="processing-spinner"></div>
      <h3 class="processing-title">{{ processingStatus() }}</h3>
      <div class="processing-progress-bar">
        <div class="processing-progress-fill" [style.width.%]="processingProgress()"></div>
      </div>
      <p class="processing-percentage">{{ processingProgress() }}%</p>
      <p class="processing-info">Veuillez patienter, traitement audio en cours...</p>
    </div>
  </div>
}
